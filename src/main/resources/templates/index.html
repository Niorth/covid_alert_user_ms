<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Covid-Alert</title>

   <!-- Bootstrap core CSS -->
  <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="/css/scrolling-nav.css" rel="stylesheet">

</head>

<body id="page-top">

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand js-scroll-trigger" href="#page-top">Covid-Alert</a>
    </div>
  </nav>



  <header class="bg-primary text-white">
    <div class="container text-center">
      <h1>Welcome to Covid-Alert</h1>
   
    </div>
  </header>
  <div style="position: absolute; top:70px; right: 0;" role="alert" aria-live="assertive" aria-atomic="true" class="toast" id="toastRefresh" data-autohide="false">
    <div class="toast-header" >
      <strong class="mr-auto">Alert </strong>
      <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="toast-body">
      You are identified as a contact case. Please do a Covid test.    </div>
  </div>

  <div style="position: absolute; top:70px; right: 0;" role="alert" aria-live="assertive" aria-atomic="true" class="toast" id="toastPosition" data-autohide="false">
    <div class="toast-header" >
      <strong class="mr-auto">Alert </strong>
      <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="toast-body">
      Your position have been updated succesfuly   </div>
  </div>
  <section id="about">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 mx-auto">
          <a href="http://localhost:3000/personState/update" class="btn btn-secondary btn-lg" role="button">Change my status</a>

          <h2 id="covided"> </h2>
          <h2>Features : </h2>
          <button type="button" onclick="sendRequest()" class="btn btn-primary">Refresh statusüîÑ</button>
          <button type="button" class="btn btn-primary" id="setPosition">Send my position üó∫Ô∏è </button>
          <button type="button" class="btn btn-primary" id="history">History</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-5 bg-dark">
    <div class="container">
      <p class="m-0 text-center text-white">Copyright &copy; Covid-Alert 2020</p>
    </div>
    <!-- /.container -->
  </footer>


  <!-- Bootstrap core JavaScript -->
  <script src="/vendor/jquery/jquery.min.js"></script>
  <script src="/vendor/bootstrap/js/bootstrap.js" defer></script>
  <!-- Plugin JavaScript -->
  <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="http://localhost:8080/auth/js/keycloak.js" type="text/javascript"></script>
<script type="text/javascript" th:inline="javascript">


  const keycloak = Keycloak({
    "realm": "covid-alert",
    "auth-server-url": "http://localhost:8080/auth",
    "ssl-required": "external",
    "resource": "covid-alert/user-app",
    "public-client": true,
    "confidential-port": 0,
    "url": 'http://localhost:8080/auth',
    "clientId": 'user-app',
    "enable-cors": true
  });

  const loadData = () => {
    console.log(keycloak.subject);
    if (keycloak.idToken) {
      console.log('IDToken');
      console.log(keycloak.token)
      sendRequest()

    } else {
      keycloak.loadUserProfile(function() {
        console.log('Account Service');
        console.log(keycloak.profile.username);

      }, function() {
        console.log('Failed to retrieve user details. Please enable claims or account role');
      });
    }
  };

  const reloadData = () => {
    keycloak.updateToken()
            .success(loadData)
            .error(() => {
              console.log('Failed to load data.  User is logged out.');
            });
  }
  const sendRequest = () => {
    $.ajax({
      type: 'GET',
      url: 'http://localhost:3004/notifications/mustbenotified',
      headers: {
        "Authorization": "Bearer " + keycloak.token
      },
      dataType: 'json',
      contentType: 'application/json',
      success: function (data) {
        if(data){
          $("#toastRefresh").toast("show")
        }
        getState();
      }
    });
  }
  const getState = () => {
    $.ajax({
      type: 'GET',
      url: 'http://localhost:3002/personState/currentstate',
      headers: {
        "Authorization": "Bearer " + keycloak.token
      },
      dataType: 'json',
      contentType: 'application/json',
      success: function (data) {
        $('#covided').html("My status : "+data.state);
      }
    });
  }

  $( document ).ready(function() {
    keycloak.init({onLoad: 'login-required', "checkLoginIframe": false}).success(reloadData);
  });


  $("#setPosition").click(function() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(getLocationAjax);
    } else {
      console.log("position not allowed")
      //TODO : Error box
    }
  });

  function getLocationAjax(position) {
    $.ajax({
      type: "POST",
      contentType: 'application/json',
      headers: {
        "Authorization": "Bearer " + keycloak.token
      },
      url: "http://localhost:3003/positions/setPositionKafka",
      dataType: 'json',
      data: JSON.stringify({"latitude": position.coords.latitude, "longitude": position.coords.longitude, "accuracy": position.coords.accuracy}),
      timeout: 100000,
      success: function (id) {
        console.log("SUCCESS: ", id);
        $("#toastPosition").toast("show")
      },
      error: function (e) {
        console.log("ERROR: ", e);
      },
      done: function (e) {
        console.log("DONE");
      }
    });
  }

  $("#history").click(function() {
    window.location.href = 'http://localhost:3002/personState/states'
  });
</script>

</html>
